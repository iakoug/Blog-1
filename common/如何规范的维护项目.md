# 如何规范的维护项目

如今，在项目多人协作开发时，越来越看重代码的规范性和可维护性了。

笔者有幸在大学毕业时带领团队对老旧项目进行了重构，并推动了代码规范、CodeReview等。从而提高了代码质量和可维护性。在这里记录下之前的一些实践经验。如果你对完整的项目配置感兴趣，可以查看 github 仓库中的[vue3-pro](https://github.com/kerwin-ly/vue3-pro)项目中找到。

## 1. lint + prettier 校验代码并格式化

`prettier`只会对代码的格式进行检查和修复。但有时候，我们需要对其 js/css 等语法进行校验，就需要用`eslint`和`stylelint`。

同时这里强烈建议使用统一的 IDE [VSCode](https://code.visualstudio.com/)（如果官网下载很慢，尝试[修改源](https://zhuanlan.zhihu.com/p/112215618)），方便统一插件和`settings.json`配置

### eslint 对ts/js校验

安装依赖：

```shell
yarn add eslint eslint-plugin-vue @typescript-eslint/parser @typescript-eslint/eslint-plugin -D
```

- eslint: ESLint 的核心代码

- eslint-plugin-vue：ESLint 关于检测 vue 代码规范的插件

- @typescript-eslint/parser：ESLint 的解析器，用于解析 typescript，从而检查和规范 Typescript 代码

- @typescript-eslint/eslint-plugin：这是一个 ESLint 插件，包含了各类定义好的检测 Typescript 代码的规范

安装完依赖后添加[.eslintrc.js](https://github.com/kerwin-ly/vue3-pro/blob/master/.eslintrc.js)和[.eslintignore](https://github.com/kerwin-ly/vue3-pro/blob/master/.eslintignore)配置文件。

最后在`VSCode`的扩展程序中安装`ESlint`，从而在编辑器中直观看到错误提示。

### stylelint 对样式校验

安装依赖：

```shell
yarn add stylelint stylelint-config-standard -D
```

- stylelint: stylelint 的核心代码

- stylelint-config-standard: stylelint 官方共享的标准规则集成。

安装完依赖后添加[.stylelintrc](https://github.com/kerwin-ly/vue3-pro/blob/master/.stylelintrc) lint 规则。

最后在`VSCode`扩展程序中安装`stylelint`，便于在编写样式代码时直观看到报错信息（红色波浪线）。

### prettier 自动格式化代码

[prettier](https://prettier.io/)支持自动格式化多种文件，包括：ts、js、html、json 等。这里我们可以统一用它来格式化。

先安装依赖：

```shell
yarn add prettier eslint-config-prettier eslint-plugin-prettier -D
```

- prettier：prettier 插件的核心代码

- eslint-config-prettier：解决 ESLint 中的样式规范和 prettier 中样式规范的冲突，以 prettier 的样式规范为准，使 ESLint 中的样式规范自动失效

- eslint-plugin-prettier：将 prettier 作为 ESLint 规范来使用

`prettier`会有一套默认的规则，如果你对某些规则不是太满意。可以在项目的根目录中添加`.prettierrc`文件，对全局配置进行覆盖。比如：`prettier`默认会在`对象`末尾添加逗号。如果需要忽略它，你可以在`.prettierrc`文件中这么做：

```json
{
  "trailingComma": "none"
}
```

最后在`VSCode`中搜索扩展程序`Prettier - Code formatter`并安装。如果需要在保存代码时，自动格式化代码。可以修改[.vscode/settings.json](https://github.com/kerwin-ly/vue3-pro/blob/master/.vscode/settings.json)

比如：

```json
{
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.formatOnSave": true
  }
}
```

## 2. husky 提交代码前进行 lint 校验

为防止忘记对代码执行lint的情况，我们可以修改git hooks的钩子函数，在提交代码前自动执行一次lint。

首先安装依赖：

```shell
yarn add lint-staged husky -D
```

* [husky](https://github.com/typicode/husky): 基于git hooks对其暴露的钩子进行修改（如：在commit前对所有代码进行lint自动校验）

* [lint-staged](https://github.com/okonet/lint-staged): 一个在git暂存文件上运行linters的工具

第一次运行项目时，执行以下命令初始化：

```shell
npm set-script prepare "husky install" # 添加script脚本快捷命令
npm run prepare # 执行脚本命令
npx husky add .husky/pre-commit "npx lint-staged"
```

执行完以上命令后，会在项目根目录位置新增`.husky`文件夹和[.husky/pre-commit](https://github.com/kerwin-ly/vue3-pro/blob/master/.husky/pre-commit)文件。

.husky/pre-commit
```shell
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged
```

接着，我们在根目录新增[.lintstagedrc.js](https://github.com/kerwin-ly/vue3-pro/blob/master/.lintstagedrc.js)文件并编写lint内容。

.lintstagedrc.js
```js
module.exports = {
  "*.{js,ts,vue}": "eslint",
  "*.{vue,less}": "stylelint"
}
```

## 3. commitlint 对代码提交格式校验

未防止出现“111”之类的无意义提交，便于生成`CHANGELOG.md`。我们需要对每次commit的格式进行约束。

```shell
yarn add @commitlint/config-conventional @commitlint/cli -D
```

执行以下命令，在项目根目录新建[commitlint.config.js](https://github.com/kerwin-ly/vue3-pro/blob/master/commitlint.config.js)

```shell
echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
```
 
然后在git 的 `commit-msg` 钩子中添加该lint校验。执行如下命令：

```shell
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"' 
```

执行成功后，会新建[.husky/commit-msg](https://github.com/kerwin-ly/vue3-pro/blob/master/.husky/commit-msg)文件并添加内容。

commit-msg
```shell
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

#--no-install 参数表示强制npx使用项目中node_modules目录中的commitlint包
npx --no-install commitlint --edit "$1"
```

一次正确的提交应该是：

```shell
git commit -m 'feat: add login list page'
```

如果你想知道更多，请阅读[commitlint文档](https://github.com/conventional-changelog/commitlint#config)

## 4. CodeReview

Lint只能帮助我们对代码格式等进行校验，并不能保证代码质量。所以，我们需要`CodeReview`来把控代码质量。

当然，如果希望节省人员Review的时间。你可以在CI中添加一个Sonar检测的步骤。代码提交后，先经过[SonarQube](https://www.sonarqube.org/)对代码进行一次机器审核。通过后，才能指派给对应同学 Review。

`CodeReview`相关规范可以参考如下：

[clean-code-javascript](https://github.com/ryanmcdermott/clean-code-javascript)
