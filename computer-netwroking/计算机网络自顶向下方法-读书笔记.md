#  计算机网络自顶向下方法

## 1. 计算机网络和因特网

### 1.1 什么是因特网

#### 1.1.1 具体构成描述

从因特网的组成部件角度出发：

由不同的主机（端系统）所组成的网络叫做`因特网`。其中`主机`不仅仅是桌面PC、服务器等，也可以是一些非传统设备，如：电视、游戏机、家用电器等。

端系统通过`通信链路(communication link)`和`分组交换机(packet switch)`连接到一起。

* 通信链路：不同类型的`通信链路`由不同类型的物理媒体组成，如：同轴电缆、光纤和无线电频谱。其不同`通信链路`有不同的传输速率，其以比特/秒(bit/s，或bps)度量

* 分组：当一个端系统向另外一个端系统发送数据前，发送端系统需要先将数据进行分段，并为每段加上首部字节，由此组成的信息包，叫做分组。

* 分组交换机：分组交换机从它的一条`入通信链路`接收分组，并从另外一条`出通信链路`转发该分组。常见的有`路由器(router)`和`链路层交换机(link-layer switch)`。路由器工作于`接入网`（待补充），链路层交换机常用于`网络核心`（待补充）。

端系统通过`因特网服务提供商(Internet Service Provider, ISP)`接入因特网。（ISP包括住宅区ISP、公司ISP、智能手机和其他设备提供移动接入的蜂窝数据ISP等）。每个ISP自身就是一个由多台分组交换机和多段通信链路组成的网络。各ISP为端系统提供了不同的接入方式，如：住宅宽带接入、高速局域网和移动无线接入等。

#### 1.1.2 服务描述

从因特网为应用程序提供服务的基础设施出发：

因特网还包括移动智能手机和平板电脑应用程序，如：即时通讯、来自云的音乐、电影、多人游戏等。这些应用程序涉及到多个相互交换数据的端系统，即`分布式应用程序（distributed application）`。

要实现不同端系统上应用程序的交互，**起始端系统的应用程序**需要通过`套接字接口（socket interface）`请求**因特网基础设施**向**目的端系统上的应用程序**交付数据。该接口是一套发送程序必须遵循的规则集合，因特网才能将数据交付到目的地。（比如：张三洗完信后如果直接扔出窗外，则无法达到李四那里。需要写上李四的邮政编码，联系方式，姓名等，再交给邮政公司，由邮政对其信息识别成功后，转交给李四）

#### 1.1.3 网络协议

协议定义了两个或多个通信实体之间交换的`报文格式`和`次序`，以及在报文传输/接收其他事件方面所采取的`动作`

#### 1.2 网络结构

互联网按组成类型由`网络边缘`、`网络核心`和`接入网`组成。

### 1.2.1 网络边缘

由端系统（主机）构成，主机又分为客户端(client)和服务器(server)。存储应用程序。

### 1.2.2 接入网

有线或无线的通信链路，用于将端系统连接到网络核心。实际上，它是将端系统物理连接到`边缘路由器`（端系统到任何其他远程端系统路径上的第一台路由器）。

宽带住宅接入有两种最流行的类型数字户(Digital Subscriber Line,DSL)和电缆。

* DSL:住户通过电话线接入本地电话公司处获得DSL因特网接入，位于电话公司的本地中心局交换数据。

![DSL图](https://raw.githubusercontent.com/kerwin-ly/Blog/master/assets/imgs/internet/dsl.png)

* 电缆接入：利用有线电视公司有线电视基础设施接入网络

* 光纤到户：最简单的光纤分布网络为，从本地中心局到每户设置一根光纤。更为一般的是 从中心局岀来的每根光纤实际上由许多家庭共享，直到对接近这些家庭 位置，才为每户分成一个独享光纤。

除了以上接入方式外，还有以太网和wifi的形式接入。

### 1.2.3 网络核心

互连的路由器，用于数据交换。

通过网络链路和交换机移动数据有两种基本方法：`电路交换(circuit switching)`和`分组交换(packet switching)`。

* **电路交换**：在发送方发送信息前，该网络必须在发送方和接受方之间建立一条连接。其建立连接的时候，预留了端系统之间沿路通信所需要的资源，也就是预留了其带宽，这使得让发送方能够以恒定速率向接收方发送数据。（如：电话网络）

* **分组交换**：端系统发送数据前，将数据拆分为一个个小的数据块，即：分组。其通常通过`存储转发传输`方式传输数据，即在数据的传输中，经过每个交换节点时，需要将其分组的所有比特都接收完后，才能往通信链路继续传输。

* **电路交换和分组交换的区别**：

**电路交换：**

1.按照`频分复用`、`时分复用`和`波分复用`的区别，将链路划分为一个个频段、时隙和波段，用户仅仅享用其中一段。不享用整个链路的资源。

2.通信前，需要先建立连接

3.独享链路的一段资源，传输稳定，速率恒定

**分组交换：**

1.传输前，将资源先分解成多个分组。传输方式分为虚电路和数据报。数据报方式传输每个分组时，每个分组需保留目标主机的完整路径，路由器不维护主机之间的通信状态。采用虚电路方式，在通信前需要在各个交换节点和目标主机间需建立虚电路，并维护之间的通信状态。

2.经过交换节点前，需要将整个分组接收完后，才能在通信链路上继续传输

3.享用整个链路的资源，但与其他用户共享，速率不稳定

### 1.3 ISP（Internet Service Provider）

`ISP`提供了将端系统接入到因特网的能力。今天的因特网实际是一个**网络的网络**。其由十多个第一层ISP和数十万个较低层的ISP组成。

其中如果位于相同等级结构层次的`ISP`能够实现对等(peer)，则其可以直接将他们的网络连接到一起，无需通过上层的`中间ISP`转发。这种模式通过`因特网交换点(Internet Exchange Point, IXP)`实现，`IXP`是一个汇合点，多个`ISP`在这里一起对等。

`ICP(Internet Content Provider)`如谷歌等，它们提供了端系统上的应用程序。其也可以通过建立`数据中心（Data Center）`和专线网络的方式，来绕过部分`ISP`。通过专线网络，让上层`ISP`和最底层的`接入ISP`直接互联。

![ISP](https://raw.githubusercontent.com/kerwin-ly/Blog/master/assets/imgs/internet/isp.png)

### 1.4 分组延时、丢失和吞吐量

#### 时延的类型

* 处理时延：检查分组首部和决定该分组导向（提取分组中的ip地址，查路由表决定下一个导向），检查分组中比特级别的差错；

* 排队时延：分组在链路上等待传输的时间，其会随着流量强度的增大而变长。当流量强度大于1时，表明其比特到达对队列的时间大于从队列传出的时间，排队时延趋于无穷大。如下图：

![ISP](https://raw.githubusercontent.com/kerwin-ly/Blog/master/assets/imgs/internet/queue-time.png)

(L：分组中比特数，a：分组叨叨队列的平均时间，R：传输速率。流量强度 = La / R)

* 传输时延：将所有分组的比特推向链路所需要的时间

* 传播时延：一个比特从链路起点到下一个路由器所需要的时间

![transfer](https://raw.githubusercontent.com/kerwin-ly/Blog/master/assets/imgs/internet/transfer.png)

#### 丢包
一条链路中排队容量是有限的，当到达的分组发现其是一个满的队列时，由于没有地方存储这个分组，路由器将丢弃这些分组

#### 吞吐量
在源端和目标端的传输速率（数据量/单位时间）。

* 瞬时吞吐量：在一个时间点的速率

* 平均吞吐量：在一个长时间内的平均值

#### 1.5 协议层次及服务模型

因特网是一个极为复杂的系统，设计者通过分层的方式，阻止协议以及实现这些协议的网络硬件和软件。

##### 协议栈（TCP/IP协议）

各层的所有协议被称为`协议栈(protocol stack)`。因特网的协议栈由5个层次组成：物理层、链路层、网络层、运输层和应用层。如下图：

![iso-level](https://raw.githubusercontent.com/kerwin-ly/Blog/master/assets/imgs/internet/transfer.png)

* 应用层：一个端系统的应用程序使用协议与另一个端系统中的应用程序交换信息分组，交换应用报文。协议包括：FTP、HTTP、DNS等。该层的分组称为`报文(message)

* 传输层：在应用程序端点之间传送应用层报文，相比于网络层，提供更可靠的服务。解决**进程到进程之间的区分**。有两种传输协议：面向连接的服务（如：TCP）和无链接的服务（如：UDP）。该层的TCP协议中的分组称为`报文段(segment)`，UDP无连接的称为`UDP数据报`.

* 网络层：获取传输层递交过来的报文段和目的地址，将网络层的分组从一台主机移动到另一台主机，解决**端到端的数据传输**。因特网的网络层包括网际协议**IP**，该协议定义了在数据报中的各个字段以及端系统和路由器如何作用于这些字段。该层的分组称为`数据报(datagram)`

* 链路层：将分组从一个节点（主机或路由器）移动到路径上的下一个节点，解决**相邻两点的数据传输**。协议包括：WIFI、WLAN、PPP等，其和物理层协议一致。该层的分组称为`帧(frame)`。

* 物理层：将链路层中的帧中的一个个比特从一个节点移动到下一个节点。

封装和解封装：
![level-relation](https://raw.githubusercontent.com/kerwin-ly/Blog/master/assets/imgs/internet/level-relation.png)

##### OSI 参考模型

* 应用层：...

* 表示层：允许应用解释传输的数据。如：加密、压缩等

* 会话层：数据交换的同步，检查点，恢复

* 传输层/网络层/链路层/物理层

## 2. 应用层

### 2.1 应用层原理

#### 2.2.1 网络应用的体系架构：客户-服务器模式（C/S架构）、对等模式（P2P）、混合体（C/S和P2P）

* 客户-服务器模式：一个总是打开的主机称为服务器，其拥有一定固定的ip地址，供客户端访问。可扩展性差，当并发达到一定量时，会出现断崖式性能下降。可以通过建立数据中心，配备大量主机来解决。

* P2P模式：客户端可以请求服务端资源，当资源被返回后，也可以作为服务端向其他客户端发送资源。它们之间是相互对等的。可扩展性强。

* 混合体：通过C/S架构将客户IP的资源目录上传到中心服务器。有客户端需要下载资源时，检查中心服务器上的各个IP，哪个客户端有资源且是开机状态，然后通过P2P模式去请求该客户端的资源。

#### 2.2.2 进程通信

在同一个端系统中进程之间通过其进程间通信机制相互通信。而在不同端系统上，需要跨越计算机网络交换报文来相互通信。

这里，我们主要研究不同端系统上的进程通信

多数应用程序由成对的进程组成（客户/服务器），从应用层的一个进程向另一个应用层进程发送报文必须通过下层传输层的网络。即`套接字接口（socket api）`向网络传送和接收数据。而`套接字接口`的需要 `发送方进程`、`数据内容`和`接收方进程`三个参数才能实现。

标识一个唯一进程： ip地址 + 协议类型(TCP/UDP) + 端口号

如果使用面对连接的服务（TCP），每次应用层之间的进程通信，都需要带上其`发送方进程（IP + 端口号）`、`数据内容`和`接收方进程（IP + 端口号）`三个参数。而`发送方进程（IP + 端口号）`和`接收方进程（IP + 端口号）`是固定的。实际上不需要每次都让层与层之间的传输带上该相同参数。

我们通过可以通过`TCP`的`套接字（socket）`的方式来避免该情况，它**是四元组的一个具有本地意义的标识**。源传输层该标识发送到目标传输层后，通过查询`TCP socket表`解析该`套接字`，从而获得其四元组的内容，即源应用进程 和 目标应用进程信息。（四元组：源IP + 源端口 + 目标IP + 目标端口）